function e(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var o=n.call(e,t||"default");if("object"!=typeof o)return o;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}function t(t,n,o){return(n=e(n))in t?Object.defineProperty(t,n,{value:o,enumerable:!0,configurable:!0,writable:!0}):t[n]=o,t}const n="http://www.w3.org/2000/svg";class o{constructor(e,o,i,s,r){t(this,"_joinSucceeded",!1),t(this,"_joinFailed",!1),t(this,"selectVendor",(e=>{this._selectedVendor=e,this.renderJoinContents()})),t(this,"unselectVendor",(()=>{this._selectedVendor=void 0,this._joinFailed=!1,this.renderJoinContents()})),t(this,"fetchVendorList",(async()=>{const e=new URL(this._derapiApiUrl+"/join/session/".concat(this._sessionToken,"/vendors"),this._derapiApiUrl),t=new Headers;t.append("Authorization","Bearer ".concat(this._derapiToken)),t.append("Content-Type","application/json");const n=await fetch(e.toString(),{method:"GET",headers:t});return await n.json()})),t(this,"setSuccess",(()=>{this._joinSucceeded=!0,this.renderJoinContents(),this._onSuccess()})),t(this,"setFailure",(()=>{this._joinFailed=!0,this.renderJoinContents()})),t(this,"createCloseButton",(()=>{const e=document.createElement("div");e.style.width="100%",e.style.height="24px",e.style.display="flex",e.style.flexDirection="row",e.style.justifyContent="end";const t=document.createElementNS(n,"svg");t.style.width="24px",t.style.height="24px",t.setAttribute("viewBox","0 0 24 24"),t.addEventListener("click",(()=>{this.close()}));const o=document.createElementNS(n,"path");return o.setAttribute("d","M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"),t.appendChild(o),e.appendChild(t),e})),t(this,"createJoinTitle",(()=>{const e=document.createElement("div");e.style.display="flex",e.style.flexDirection="column",e.style.alignItems="center";const t=this.createCloseButton();e.appendChild(t);const n=document.createElement("div");n.style.fontSize="1.2em",n.style.fontWeight="700",n.innerText="Derapi Join";const o=document.createElement("div");return o.innerText="Select your provider from the list below",e.appendChild(n),e.appendChild(o),e})),t(this,"createVendorList",(e=>{const t=[];return e.map((e=>{const n=document.createElement("div");n.style.display="flex",n.style.flexDirection="column",n.style.alignItems="center",n.style.gap=".1em",n.style.marginTop=".3em";const o=document.createElement("hr");o.style.width="100%",o.style.backgroundColor="rgba(0, 0, 0, 0.2)",o.style.borderColor="rgba(0, 0, 0, 0.2)",n.appendChild(o);const i=document.createElement("button");i.style.borderStyle="none",i.style.backgroundColor="transparent",i.addEventListener("click",(()=>{this.selectVendor(e)}));const s=document.createElement("img");s.src=e.base64Logo,i.appendChild(s),n.appendChild(i),t.push(n)})),t})),t(this,"createOAuthView",(e=>{const t=document.createElement("div");t.textContent="Redirecting to ".concat(e.name," to join your account.");const n=e.oAuthEndpoint,o=async()=>{const e=new URL(this._derapiApiUrl+"/join/session/".concat(this._sessionToken,"/fetch-token"),this._derapiApiUrl),t=new Headers;t.append("Authorization","Bearer ".concat(this._derapiToken)),t.append("Content-Type","application/json");const n=await fetch(e.toString(),{method:"GET",headers:t});if(!(await n.json()).access_token)throw new Error("failed to create token")},i=()=>{o().then((()=>{this.setSuccess()})).catch((()=>{this.setFailure()}))},s=window.open(n,"*","popup");if(s)var r=setInterval((function(){s.closed&&(clearInterval(r),i())}),1e3);return t})),t(this,"createCustomOAuthView",(e=>{const t=document.createElement("div");t.style.display="flex",t.style.flexDirection="column",t.style.alignItems="center",t.style.gap="1.2em";const n=document.createElement("img");n.src=e.base64Logo,t.appendChild(n);const o=document.createElement("div");o.style.display="flex",o.style.flexDirection="column",o.style.alignItems="left",o.style.gap=".2em";const i=document.createElement("label");i.setAttribute("for","derapi-join-username-input"),i.style.color="rgba(0, 0, 0, 0.6)",i.textContent="API Key ID",o.appendChild(i);const s=document.createElement("input");s.setAttribute("type","text"),s.style.borderRadius="4px",s.style.padding=".5em",s.id="derapi-join-username-input",o.appendChild(s),t.appendChild(o);const r=document.createElement("div");let l;if(r.style.display="flex",r.style.flexDirection="column",r.style.alignItems="left",r.style.gap=".2em","solaredge"!=e.id){const e=document.createElement("label");e.setAttribute("for","derapi-join-password-input"),e.style.color="rgba(0, 0, 0, 0.6)",e.textContent="API Key Secret",r.appendChild(e),l=document.createElement("input"),l.setAttribute("type","password"),l.style.borderRadius="4px",l.style.padding=".5em",l.id="derapi-join-password-input",r.appendChild(l),t.appendChild(r)}const a=document.createElement("button");a.style.borderRadius="4px",a.style.backgroundColor="#FFA62B",a.style.boxShadow="rgba(0, 0, 0, 0.2) 0px 3px 1px -2px, rgba(0, 0, 0, 0.14) 0px 2px 2px 0px, rgba(0, 0, 0, 0.12) 0px 1px 5px 0px",a.style.borderStyle="none",a.style.color="white",a.style.padding=".5em",a.style.paddingRight="1em",a.style.paddingLeft="1em",a.style.minWidth="100px",a.textContent="JOIN";const d=(e,t,n)=>{a.disabled=!0,a.style.opacity=".5",c(e,t,n).then((()=>{this.setSuccess()})).catch((()=>{this.setFailure()}))},c=async(e,t,n)=>{const o="".concat(t,":").concat(n),i=new URL(this._derapiApiUrl+"/join/".concat(e.id,"/auth-granted?state=").concat(this._sessionToken,"&code=").concat(o),this._derapiApiUrl),s=new Headers,r=await fetch(i.toString(),{method:"GET",headers:s});if(!r.ok)throw new Error("custom oAuth failed: ".concat(r.status));if((await r.text()).includes("failed"))throw new Error("custom oAuth failed")};return a.addEventListener("click",(()=>{const t=s.value,n=l?l.value:"";d(e,t,n)})),s.addEventListener("keydown",(t=>{if("Enter"==t.key){const t=s.value,n=l?l.value:"";d(e,t,n)}})),l&&l.addEventListener("keydown",(t=>{if("Enter"==t.key){const t=s.value,n=l?l.value:"";d(e,t,n)}})),t.appendChild(a),t})),t(this,"createLoadingSpinner",(()=>{const e=document.createElement("div");e.style.width="50px",e.style.height="50px",e.style.margin="2em";const t=document.createElement("span");t.style.display="block",t.style.width="50px",t.style.height="50px",t.style.color="#34aeeb";const o=document.createElementNS(n,"svg");o.style.display="block",o.setAttribute("viewBox","22 22 44 44"),o.setAttributeNS("http://www.w3.org/2000/xmlns/","xmlns:xlink","http://www.w3.org/1999/xlink");const i=document.createElementNS(n,"circle");i.setAttribute("cx","44"),i.setAttribute("cy","44"),i.setAttribute("r","20.2"),i.setAttribute("fill","none"),i.setAttribute("stroke","#34aeeb"),i.setAttribute("stroke-width","3.6"),i.setAttribute("stroke-dasharray",".5"),i.setAttribute("pathLength","1");const s=document.createElementNS(n,"animate");return s.setAttribute("attributeName","stroke-dashoffset"),s.setAttribute("values","0;.33;.66;1;"),s.setAttribute("repeatCount","indefinite"),s.setAttribute("dur","1s"),i.appendChild(s),o.appendChild(i),t.appendChild(o),e.appendChild(t),e})),t(this,"createBackButton",(()=>{const e=document.createElement("div");e.style.width="100%",e.style.display="flex",e.style.flexDirection="row",e.style.justifyContent="start",e.style.alignItems="center",e.style.gap="1em",e.style.marginBottom="1.5em";const t=document.createElementNS(n,"svg");t.style.width="24px",t.style.height="24px",t.setAttribute("viewBox","0 0 24 24"),t.addEventListener("click",(()=>{this.unselectVendor()}));const o=document.createElementNS(n,"path");o.setAttribute("d","M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20z"),t.appendChild(o),e.appendChild(t);const i=document.createElement("div");return i.style.fontSize=".8em",i.textContent="Back to Vendor Selection",e.appendChild(i),e})),t(this,"createSuccessView",(()=>{var e;const t=document.createElement("div");t.style.display="flex",t.style.flexDirection="column",t.style.alignItems="center",t.style.gap="1em";const o=this.createCloseButton();t.appendChild(o);const i=document.createElementNS(n,"svg");i.style.color="rgb(0, 128, 0)",i.style.fill="rgb(0, 128, 0)",i.style.width="140px",i.style.height="140px",i.setAttribute("viewBox","0 0 24 24");const s=document.createElementNS(n,"path");s.style.color="rgb(0, 128, 0)",s.style.fill="rgb(0, 128, 0)",s.setAttribute("d","M16.59 7.58 10 14.17l-3.59-3.58L5 12l5 5 8-8zM12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2m0 18c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8"),i.appendChild(s),t.appendChild(i);const r=document.createElement("div");return r.innerText="Thank you for linking your ".concat(null===(e=this._selectedVendor)||void 0===e?void 0:e.name," account."),t.appendChild(r),t})),t(this,"createFailedView",(()=>{var e;const t=document.createElement("div");t.style.display="flex",t.style.flexDirection="column",t.style.gap=".5em";const n=this.createBackButton();t.appendChild(n);const o=document.createElement("div");return o.style.color="#FF6A6A",o.textContent="Failed to Join your ".concat(null===(e=this._selectedVendor)||void 0===e?void 0:e.name," account."),t.appendChild(o),t})),t(this,"renderSelectedVendor",(()=>{if(this._selectedVendor&&this._root){const e=this.createBackButton();if(this._root.appendChild(e),this._selectedVendor.oAuthEndpoint){const e=this.createOAuthView(this._selectedVendor);this._root.appendChild(e)}else{const e=this.createCustomOAuthView(this._selectedVendor);this._root.appendChild(e)}}})),t(this,"renderJoinContents",(()=>{if(this._root||this.renderAndOpenModal(),!this._root)throw new Error("missing join dialog");if(this._root.textContent="",this._joinSucceeded){const e=this.createSuccessView();this._root.appendChild(e)}else if(this._joinFailed){const e=this.createFailedView();this._root&&this._root.appendChild(e)}else if(this._selectedVendor)this.renderSelectedVendor();else{const e=this.createJoinTitle();if(this._root.appendChild(e),this._vendors&&this._vendors.length>0){this.createVendorList(this._vendors).map((e=>{this._root&&this._root.appendChild(e)}))}else{const e=this.createLoadingSpinner();this._root.appendChild(e)}}})),t(this,"createJoinDialog",(()=>{const e=document.createElement("dialog");e.style.fontFamily="Sen, sans-serif",e.style.position="absolute",e.style.top="0",e.style.left="0",e.style.bottom="0",e.style.right="0",e.style.borderRadius="4px",e.style.height="600px",e.style.width="350px",e.style.maxHeight="600px",e.style.maxWidth="350px",e.style.margin="auto",e.style.backgroundColor="#fff",e.style.padding="1em",e.style.borderStyle="none",e.style.boxShadow="rgba(0, 0, 0, 0.2) 0px 2px 1px -1px, rgba(0, 0, 0, 0.14) 0px 1px 1px 0px, rgba(0, 0, 0, 0.12) 0px 1px 3px 0px",e.style.display="flex",e.style.flexDirection="column",e.style.alignItems="center";const t=document.querySelector("dialog::backdrop");return null==t||t.setAttribute("backdrop-filter","opacity(.2)"),e})),t(this,"_root",void 0),t(this,"renderAndOpenModal",(()=>{this._root=this.createJoinDialog(),document.body.appendChild(this._root),this._root.open||this._root.showModal()})),t(this,"open",(()=>{this.renderAndOpenModal(),this.renderJoinContents(),this.fetchVendorList().then((e=>{this._vendors=e,this._root&&this.renderJoinContents()}))})),t(this,"removeRoot",(()=>{this._root&&(this._root.open&&this._root.close(),document.body.removeChild(this._root))})),t(this,"close",(()=>{this.removeRoot(),this._onClose()})),this._onSuccess=o,this._onClose=i,this._sessionToken=e,this._derapiToken=s,this._derapiApiUrl=r,this._selectedVendor=void 0,this._vendors=void 0}}const i={createJoin:(e,t,n,i,s)=>{let r=s;r||(r="https://api.derapi.com");const l=new o(e,t,n,i,r);return{open:l.open,close:l.close}},fetchDerapiToken:async(e,t)=>{const n=new Headers;n.append("Authorization","Basic "+btoa(e+":"+t)),n.append("Content-Type","application/x-www-form-urlencoded");const o=await fetch("https://auth.derapi.com/oauth2/token".toString(),{method:"POST",headers:n,body:"grant_type=client_credentials"});return(await o.json()).access_token},createSession:async function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"https://api.derapi.com";const o=new URL(n+"/join/session/start",n),i=new Headers;i.append("Authorization","Bearer ".concat(t)),i.append("Content-Type","application/json");const s={vendorCredentials:e},r=await fetch(o.toString(),{method:"POST",headers:i,body:JSON.stringify(s)});return(await r.json()).session_id}};export{i as default};
//# sourceMappingURL=bundle.esm.min.js.map
